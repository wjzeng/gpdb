-- Don't dispatch 'client_encoding'
-- When client_encoding is dispatch to QE, error messages generated in QEs were
-- converted to client_encoding, but QD assumed that they were in server encoding,
-- it will leads to corruption. 
set client_encoding = 'latin1';
create function raise_error(t text) returns void as $$
begin
  raise exception 'raise_error called on "%"', t;
end;
$$ language plpgsql;
select raise_error('funny char ' || chr(196)) from gp_dist_random('gp_id');
ERROR:  raise_error called on "funny char ƒ"  (seg0 slice1 172.17.0.2:25432 pid=227665)
reset client_encoding;
--
-- Test buildGpQueryString of cdbdisp_query.c truncates a query longer than QUERY_STRING_TRUNCATE_SIZE and containing
-- multi-byte symbols properly
--
set log_min_duration_statement to 0;
create table truncate_test ("–∫–æ–ª–æ–Ω–∫–∞ 1" int, "–∫–æ–ª–æ–Ω–∫–∞ 2" int, "–∫–æ–ª–æ–Ω–∫–∞ 3" int, "–∫–æ–ª–æ–Ω–∫–∞ 4" int, "–∫–æ–ª–æ–Ω–∫–∞ 5" int,
"–∫–æ–ª–æ–Ω–∫–∞ 6" int, "–∫–æ–ª–æ–Ω–∫–∞ 7" int, "–∫–æ–ª–æ–Ω–∫–∞ 8" int, "–∫–æ–ª–æ–Ω–∫–∞ 9" int, "–∫–æ–ª–æ–Ω–∫–∞ 10" int, "–∫–æ–ª–æ–Ω–∫–∞ 11" int,
"–∫–æ–ª–æ–Ω–∫–∞ 12" int, "–∫–æ–ª–æ–Ω–∫–∞ 13" int, "–∫–æ–ª–æ–Ω–∫–∞ 14" int, "–∫–æ–ª–æ–Ω–∫–∞ 15" int, "–∫–æ–ª–æ–Ω–∫–∞ 16" int, "–∫–æ–ª–æ–Ω–∫–∞ 17" int,
"–∫–æ–ª–æ–Ω–∫–∞ 18" int, "–∫–æ–ª–æ–Ω–∫–∞ 19" int, "–∫–æ–ª–æ–Ω–∫–∞ 20" int, "–∫–æ–ª–æ–Ω–∫–∞ 21" int, "–∫–æ–ª–æ–Ω–∫–∞ 22" int, "–∫–æ–ª–æ–Ω–∫–∞ 23" int,
"–∫–æ–ª–æ–Ω–∫–∞ 24" int, "–∫–æ–ª–æ–Ω–∫–∞ 25" int, "–∫–æ–ª–æ–Ω–∫–∞ 26" int, "–∫–æ–ª–æ–Ω–∫–∞ 27" int, "–∫–æ–ª–æ–Ω–∫–∞ 28" int, "–∫–æ–ª–æ–Ω–∫–∞ 29" int,
"–∫–æ–ª–æ–Ω–∫–∞ 30" int, "–∫–æ–ª–æ–Ω–∫–∞ 31" int, "–∫–æ–ª–æ–Ω–∫–∞ 32" int, "–∫–æ–ª–æ–Ω–∫–∞ 33" int, "–∫–æ–ª–æ–Ω–∫–∞ 34" int, "–∫–æ–ª–æ–Ω–∫–∞ 35" int,
"–∫–æ–ª–æ–Ω–∫–∞ 36" int, "–∫–æ–ª–æ–Ω–∫–∞ 37" int, "–∫–æ–ª–æ–Ω–∫–∞ 38" int, "–∫–æ–ª–æ–Ω–∫–∞ 39" int, "–∫–æ–ª–æ–Ω–∫–∞ 40" int, "–æ—Å–æ–±–∞—è –∫–æ–ª–æ–Ω–∫–∞" int);
select logdebug from gp_toolkit.__gp_log_segment_ext where logdebug ilike
'%create table truncate_test%' and logdebug not ilike '%gp_toolkit.__gp_log_segment_ext%' order by logtime desc limit 1;
                                                     logdebug                                                     
------------------------------------------------------------------------------------------------------------------
 create table truncate_test ("–∫–æ–ª–æ–Ω–∫–∞ 1" int, "–∫–æ–ª–æ–Ω–∫–∞ 2" int, "–∫–æ–ª–æ–Ω–∫–∞ 3" int, "–∫–æ–ª–æ–Ω–∫–∞ 4" int, "–∫–æ–ª–æ–Ω–∫–∞ 5" int,
 "–∫–æ–ª–æ–Ω–∫–∞ 6" int, "–∫–æ–ª–æ–Ω–∫–∞ 7" int, "–∫–æ–ª–æ–Ω–∫–∞ 8" int, "–∫–æ–ª–æ–Ω–∫–∞ 9" int, "–∫–æ–ª–æ–Ω–∫–∞ 10" int, "–∫–æ–ª–æ–Ω–∫–∞ 11" int,         
 "–∫–æ–ª–æ–Ω–∫–∞ 12" int, "–∫–æ–ª–æ–Ω–∫–∞ 13" int, "–∫–æ–ª–æ–Ω–∫–∞ 14" int, "–∫–æ–ª–æ–Ω–∫–∞ 15" int, "–∫–æ–ª–æ–Ω–∫–∞ 16" int, "–∫–æ–ª–æ–Ω–∫–∞ 17" int,     
 "–∫–æ–ª–æ–Ω–∫–∞ 18" int, "–∫–æ–ª–æ–Ω–∫–∞ 19" int, "–∫–æ–ª–æ–Ω–∫–∞ 20" int, "–∫–æ–ª–æ–Ω–∫–∞ 21" int, "–∫–æ–ª–æ–Ω–∫–∞ 22" int, "–∫–æ–ª–æ–Ω–∫–∞ 23" int,     
 "–∫–æ–ª–æ–Ω–∫–∞ 24" int, "–∫–æ–ª–æ–Ω–∫–∞ 25" int, "–∫–æ–ª–æ–Ω–∫–∞ 26" int, "–∫–æ–ª–æ–Ω–∫–∞ 27" int, "–∫–æ–ª–æ–Ω–∫–∞ 28" int, "–∫–æ–ª–æ–Ω–∫–∞ 29" int,     
 "–∫–æ–ª–æ–Ω–∫–∞ 30" int, "–∫–æ–ª–æ–Ω–∫–∞ 31" int, "–∫–æ–ª–æ–Ω–∫–∞ 32" int, "–∫–æ–ª–æ–Ω–∫–∞ 33" int, "–∫–æ–ª–æ–Ω–∫–∞ 34" int, "–∫–æ–ª–æ–Ω–∫–∞ 35" int,     
 "–∫–æ–ª–æ–Ω–∫–∞ 36" int, "–∫–æ–ª–æ–Ω–∫–∞ 37" int, "–∫–æ–ª–æ–Ω–∫–∞ 38" int, "–∫–æ–ª–æ–Ω–∫–∞ 39" int, "–∫–æ–ª–æ–Ω–∫–∞ 40" int, "–æ
(1 row)

drop table truncate_test;
reset log_min_duration_statement;
